//https://github.com/tensorflow/tfjs-examples/blob/master/react-native/pose-detection/App.tsx
//https://docs.expo.dev/versions/latest/sdk/camera/
//https://github.com/tensorflow/tfjs-models/tree/master/pose-detection
//https://js.tensorflow.org/api_react_native/0.2.1/#cameraWithTensors
//https://github.com/tensorflow/tfjs-models/blob/master/pose-detection/src/create_detector.ts
//https://github.com/tensorflow/tfjs-models/blob/master/pose-detection/src/movenet/detector.ts

//imports
import { Camera, CameraType } from "expo-camera";
import { useEffect, useState } from "react";
import { Button, Dimensions, Platform, Pressable, StyleSheet, Text, View } from "react-native";
import Svg, { Circle } from "react-native-svg";

import * as tf from "@tensorflow/tfjs";
import * as posedetection from "@tensorflow-models/pose-detection";
import { cameraWithTensors } from "@tensorflow/tfjs-react-native";

import { embed } from "./utils.js";


//globals
const TensorCamera = cameraWithTensors(Camera);

const IS_ANDROID = Platform.OS == "android";

const RATIO = IS_ANDROID ? 3 / 4 : 9 / 16;
const SCREEN_WIDTH = Dimensions.get("window").width;
const SCREEN_HEIGHT = SCREEN_WIDTH / RATIO;
const TENSOR_WIDTH = 120;
const TENSOR_HEIGHT = TENSOR_WIDTH / RATIO;
const CONFIDENCE = 0.3;


//{{{
//var motionData = [[{"name": "nose", "score": 0.4970053732395172, "x": 0.009300359042038972, "y": -0.6106740330428232}, {"name": "left_eye", "score": 0.37627336382865906, "x": 0.03428887211374646, "y": -0.6400511771333262}, {"name": "right_eye", "score": 0.5088439583778381, "x": -0.01194263233412138, "y": -0.6424722971970982}, {"name": "left_ear", "score": 0.5575082898139954, "x": 0.08016971988689425, "y": -0.5920097583432705}, {"name": "right_ear", "score": 0.5426338911056519, "x": -0.027209989112009367, "y": -0.6048349658369779}, {"name": "left_shoulder", "score": 0.8440747857093811, "x": 0.15902858073073414, "y": -0.40077980969599536}, {"name": "right_shoulder", "score": 0.7215598821640015, "x": -0.11191933650764568, "y": -0.3978319352143392}, {"name": "left_elbow", "score": 0.5172328948974609, "x": 0.17736734936129486, "y": -0.18155136352920395}, {"name": "right_elbow", "score": 0.6425831317901611, "x": -0.1596887830464714, "y": -0.1671474371515412}, {"name": "left_wrist", "score": 0.6571339964866638, "x": 0.19060404476950132, "y": 0.010978984593175287}, {"name": "right_wrist", "score": 0.3310662806034088, "x": -0.19285621753846674, "y": -0.006812167235535007}, {"name": "left_hip", "score": 0.8371464014053345, "x": 0.07165703221458264, "y": 0.00467869148049592}, {"name": "right_hip", "score": 0.8490344285964966, "x": -0.07165703221458264, "y": -0.00467869148049592}, {"name": "left_knee", "score": 0.7524532079696655, "x": 0.05340282575572356, "y": 0.3642681534907345}, {"name": "right_knee", "score": 0.6406302452087402, "x": -0.0788138493545999, "y": 0.3620621208170052}, {"name": "left_ankle", "score": 0.7517534494400024, "x": 0.052720536010637614, "y": 0.6818086142113385}, {"name": "right_ankle", "score": 0.5897777080535889, "x": -0.08334621696873831, "y": 0.6672361461185473}], [{"name": "nose", "score": 0.7761409282684326, "x": 0.022157747316557855, "y": -0.5931050301967549}, {"name": "left_eye", "score": 0.6762117147445679, "x": 0.05174482224227868, "y": -0.6188955632495725}, {"name": "right_eye", "score": 0.6202496290206909, "x": -0.0005199022484261317, "y": -0.6209779056573169}, {"name": "left_ear", "score": 0.7309901118278503, "x": 0.08371898574376645, "y": -0.5793422227898974}, {"name": "right_ear", "score": 0.7289720773696899, "x": -0.027555192032820988, "y": -0.5846403366330323}, {"name": "left_shoulder", "score": 0.9186552166938782, "x": 0.1592429061272895, "y": -0.3989576480444134}, {"name": "right_shoulder", "score": 0.8844369053840637, "x": -0.11171968158247804, "y": -0.3996295689387186}, {"name": "left_elbow", "score": 0.6902415752410889, "x": 0.25615193939716135, "y": -0.21001241808501325}, {"name": "right_elbow", "score": 0.706380307674408, "x": -0.1992901770710127, "y": -0.20860886558661498}, {"name": "left_wrist", "score": 0.7768306136131287, "x": 0.37373203727572923, "y": -0.0308268009302115}, {"name": "right_wrist", "score": 0.779361367225647, "x": -0.32985642002309395, "y": -0.03750061477191459}, {"name": "left_hip", "score": 0.9029160737991333, "x": 0.07407873643190428, "y": 0.004214450952181127}, {"name": "right_hip", "score": 0.8566232919692993, "x": -0.07407873643190369, "y": -0.004214450952181127}, {"name": "left_knee", "score": 0.8039231300354004, "x": 0.05020556803142275, "y": 0.3792964125290961}, {"name": "right_knee", "score": 0.8228389620780945, "x": -0.06874498296255614, "y": 0.37756661161004107}, {"name": "left_ankle", "score": 0.768266499042511, "x": 0.043633072913835884, "y": 0.7127096148661377}, {"name": "right_ankle", "score": 0.7511685490608215, "x": -0.06733775442806804, "y": 0.6928186453180045}], [{"name": "nose", "score": 0.4920610785484314, "x": 0.03159811788185104, "y": -0.5293609755788523}, {"name": "left_eye", "score": 0.5541514754295349, "x": 0.05783511819972304, "y": -0.544166698279576}, {"name": "right_eye", "score": 0.5951117277145386, "x": 0.019644658046640614, "y": -0.5465844791276837}, {"name": "left_ear", "score": 0.5794683694839478, "x": 0.07104037901532456, "y": -0.5278987948664285}, {"name": "right_ear", "score": 0.6326206922531128, "x": -0.01834926633336034, "y": -0.5260079335435779}, {"name": "left_shoulder", "score": 0.9385659694671631, "x": 0.14072775202891433, "y": -0.4010333177805241}, {"name": "right_shoulder", "score": 0.8859856724739075, "x": -0.10905091330446813, "y": -0.39833929739241597}, {"name": "left_elbow", "score": 0.7367314696311951, "x": 0.3435760145711334, "y": -0.384403109228576}, {"name": "right_elbow", "score": 0.7867145538330078, "x": -0.2782315183712296, "y": -0.4288791487712773}, {"name": "left_wrist", "score": 0.6621952056884766, "x": 0.47726315986423157, "y": -0.43946821957115517}, {"name": "right_wrist", "score": 0.41641223430633545, "x": -0.4401621164714606, "y": -0.5148766935953033}, {"name": "left_hip", "score": 0.9197471737861633, "x": 0.06923689213067775, "y": 0.0011287411258686702}, {"name": "right_hip", "score": 0.8268572092056274, "x": -0.06923689213067723, "y": -0.001128741125869187}, {"name": "left_knee", "score": 0.8230240941047668, "x": 0.11809931595615594, "y": 0.31542815259586393}, {"name": "right_knee", "score": 0.8860974311828613, "x": -0.11978525622998512, "y": 0.3219592337183556}, {"name": "left_ankle", "score": 0.8072795271873474, "x": 0.15992938684829225, "y": 0.6130656037358141}, {"name": "right_ankle", "score": 0.6681939363479614, "x": -0.1628627677202482, "y": 0.596866333410437}], [{"name": "nose", "score": 0.4020775556564331, "x": -0.03340906767303375, "y": -0.5397949938597664}, {"name": "left_eye", "score": 0.4190571904182434, "x": -0.06268411833803668, "y": -0.566858406196031}, {"name": "right_eye", "score": 0.5291597247123718, "x": -0.0189095868716787, "y": -0.5685121084924364}, {"name": "left_ear", "score": 0.5957127213478088, "x": -0.08107394885037389, "y": -0.5418583623402823}, {"name": "right_ear", "score": 0.5329161286354065, "x": 0.02291739453093652, "y": -0.5566068960743089}, {"name": "left_shoulder", "score": 0.7555984854698181, "x": -0.10964364314903857, "y": -0.3980752228526072}, {"name": "right_shoulder", "score": 0.8053539991378784, "x": 0.10270808143266444, "y": -0.4018947128222766}, {"name": "left_elbow", "score": 0.7316768169403076, "x": -0.16133200240662343, "y": -0.5396464898551325}, {"name": "right_elbow", "score": 0.674882173538208, "x": 0.24414519941255947, "y": -0.5353882913340308}, {"name": "left_wrist", "score": 0.23000338673591614, "x": -0.11188109241665373, "y": -0.6143673386712345}, {"name": "right_wrist", "score": 0.2906833589076996, "x": 0.24128805432518946, "y": -0.629463898188083}, {"name": "left_hip", "score": 0.7656415700912476, "x": -0.07208489124654222, "y": -0.0038345308764383586}, {"name": "right_hip", "score": 0.8811508417129517, "x": 0.07208489124654274, "y": 0.0038345308764383586}, {"name": "left_knee", "score": 0.7449536323547363, "x": -0.18422709894184214, "y": 0.2907151570088495}, {"name": "right_knee", "score": 0.7752971649169922, "x": 0.1589383836034363, "y": 0.3115236577024852}, {"name": "left_ankle", "score": 0.59554123878479, "x": -0.28541148545459566, "y": 0.5328664556979468}, {"name": "right_ankle", "score": 0.7571660876274109, "x": 0.2778160644289453, "y": 0.5370965283524095}], [{"name": "nose", "score": 0.5505774617195129, "x": 0.025501398326839005, "y": -0.5120459078044051}, {"name": "left_eye", "score": 0.42939454317092896, "x": 0.052043647336718166, "y": -0.5368091737617575}, {"name": "right_eye", "score": 0.7077151536941528, "x": 0.0033095478878696336, "y": -0.5416868353539945}, {"name": "left_ear", "score": 0.7484014630317688, "x": 0.08554102332586488, "y": -0.5116503293922359}, {"name": "right_ear", "score": 0.8344569802284241, "x": -0.014961525049096553, "y": -0.5217696938085118}, {"name": "left_shoulder", "score": 0.7297186851501465, "x": 0.1457955314134538, "y": -0.401338762937684}, {"name": "right_shoulder", "score": 0.7482151985168457, "x": -0.08719565959149221, "y": -0.39651213480101577}, {"name": "left_elbow", "score": 0.7105651497840881, "x": 0.33241678150483495, "y": -0.43865738913588265}, {"name": "right_elbow", "score": 0.9168265461921692, "x": -0.2719340098268419, "y": -0.45525436580072537}, {"name": "left_wrist", "score": 0.6455368399620056, "x": 0.4501161368550666, "y": -0.5443732273287425}, {"name": "right_wrist", "score": 0.6099634170532227, "x": -0.37831384928546263, "y": -0.5957957154634377}, {"name": "left_hip", "score": 0.8986383080482483, "x": 0.06693059887458382, "y": 0.0025212846581439555}, {"name": "right_hip", "score": 0.8365101218223572, "x": -0.06693059887458382, "y": -0.0025212846581434264}, {"name": "left_knee", "score": 0.8898174166679382, "x": 0.169459605973312, "y": 0.3171323918364678}, {"name": "right_knee", "score": 0.9128859043121338, "x": -0.1744211649050669, "y": 0.31587189398004883}, {"name": "left_ankle", "score": 0.7106325626373291, "x": 0.24489475558426074, "y": 0.5680657873451428}, {"name": "right_ankle", "score": 0.7876200079917908, "x": -0.2730415365394221, "y": 0.578490172133776}], [{"name": "nose", "score": 0.7543550133705139, "x": 0.024771042139111108, "y": -0.568864295775339}, {"name": "left_eye", "score": 0.5810064673423767, "x": 0.04855065350627984, "y": -0.594656944839951}, {"name": "right_eye", "score": 0.7290624976158142, "x": 0.000033854111403229474, "y": -0.5963224959577252}, {"name": "left_ear", "score": 0.7348796725273132, "x": 0.07830186904615294, "y": -0.566076854994377}, {"name": "right_ear", "score": 0.7018468379974365, "x": -0.028649773767393024, "y": -0.5652215649208705}, {"name": "left_shoulder", "score": 0.9020507335662842, "x": 0.14598563677308132, "y": -0.3942759639864489}, {"name": "right_shoulder", "score": 0.9234278798103333, "x": -0.09848975690853545, "y": -0.40431287978479535}, {"name": "left_elbow", "score": 0.7410607933998108, "x": 0.24659219028599755, "y": -0.22402162735437534}, {"name": "right_elbow", "score": 0.755376935005188, "x": -0.22560643600540556, "y": -0.24023244543023517}, {"name": "left_wrist", "score": 0.7668927311897278, "x": 0.35807774993350094, "y": -0.05977439813801387}, {"name": "right_wrist", "score": 0.7514947056770325, "x": -0.34944658361439934, "y": -0.0912120334421035}, {"name": "left_hip", "score": 0.907407820224762, "x": 0.07628088796131179, "y": 0.0022671187344203217}, {"name": "right_hip", "score": 0.8326746225357056, "x": -0.07628088796131124, "y": -0.0022671187344208634}, {"name": "left_knee", "score": 0.8476948738098145, "x": 0.09840644690537459, "y": 0.3335659703599122}, {"name": "right_knee", "score": 0.6857245564460754, "x": -0.1012305723298293, "y": 0.32467938211812913}, {"name": "left_ankle", "score": 0.5216189026832581, "x": 0.07234682957642961, "y": 0.6400387221904243}, {"name": "right_ankle", "score": 0.5447517037391663, "x": -0.1284911103403761, "y": 0.6323506312243169}], [{"name": "nose", "score": 0.5737499594688416, "x": 0.018721573644882115, "y": -0.5717680500727154}, {"name": "left_eye", "score": 0.5626901388168335, "x": 0.0471624731891986, "y": -0.5973645145461601}, {"name": "right_eye", "score": 0.5903226137161255, "x": -0.0008838702725846917, "y": -0.5998301146608657}, {"name": "left_ear", "score": 0.509022057056427, "x": 0.07843045467572637, "y": -0.5687900842967701}, {"name": "right_ear", "score": 0.5818313360214233, "x": -0.028362845151220114, "y": -0.5739130562501159}, {"name": "left_shoulder", "score": 0.8412566184997559, "x": 0.15149015195382978, "y": -0.39360818066536496}, {"name": "right_shoulder", "score": 0.8359118700027466, "x": -0.11297914742438496, "y": -0.4054643457864792}, {"name": "left_elbow", "score": 0.6930855512619019, "x": 0.21969293430503717, "y": -0.1853166822832258}, {"name": "right_elbow", "score": 0.5974261164665222, "x": -0.1927516166541128, "y": -0.20845711792957677}, {"name": "left_wrist", "score": 0.5957872867584229, "x": 0.28131291694947064, "y": -0.033497801169789336}, {"name": "right_wrist", "score": 0.4348369538784027, "x": -0.27218130681302777, "y": -0.07460442126833014}, {"name": "left_hip", "score": 0.8458195328712463, "x": 0.07555303444726581, "y": 0.0022777491615392073}, {"name": "right_hip", "score": 0.8740697503089905, "x": -0.07555303444726581, "y": -0.0022777491615392073}, {"name": "left_knee", "score": 0.5762655138969421, "x": 0.043921169569165516, "y": 0.3629510574933778}, {"name": "right_knee", "score": 0.7410556674003601, "x": -0.05717227115651401, "y": 0.34812440031772734}, {"name": "left_ankle", "score": 0.6781538128852844, "x": 0.036976640448349564, "y": 0.6161253819143615}, {"name": "right_ankle", "score": 0.3984127938747406, "x": -0.08344898421857126, "y": 0.6277797145888718}], [{"name": "nose", "score": 0.6656576991081238, "x": 0.02183488778046146, "y": -0.5137157290378214}, {"name": "left_eye", "score": 0.581123411655426, "x": 0.05285247371675588, "y": -0.5414414278824776}, {"name": "right_eye", "score": 0.6114472150802612, "x": -0.0003876211716949134, "y": -0.5408593488827147}, {"name": "left_ear", "score": 0.8305901288986206, "x": 0.08000130105759452, "y": -0.522828820109093}, {"name": "right_ear", "score": 0.8121340870857239, "x": -0.03414883147713611, "y": -0.5294560374836336}, {"name": "left_shoulder", "score": 0.828677773475647, "x": 0.1387960450003414, "y": -0.4001465698347189}, {"name": "right_shoulder", "score": 0.8728720545768738, "x": -0.10621459763048459, "y": -0.3991896856218228}, {"name": "left_elbow", "score": 0.5832583904266357, "x": 0.32946603934752255, "y": -0.3780796769605388}, {"name": "right_elbow", "score": 0.7519689202308655, "x": -0.30325254732076207, "y": -0.39858994017460997}, {"name": "left_wrist", "score": 0.3383176326751709, "x": 0.4622775442819825, "y": -0.3981791499802965}, {"name": "right_wrist", "score": 0.31275302171707153, "x": -0.42637321373796255, "y": -0.42651743591099917}, {"name": "left_hip", "score": 0.9444981813430786, "x": 0.07500587481628508, "y": 0.002167479364496308}, {"name": "right_hip", "score": 0.9052445888519287, "x": -0.07500587481628508, "y": -0.0021674793644958002}, {"name": "left_knee", "score": 0.8742349743843079, "x": 0.10067687243494093, "y": 0.31036834307471056}, {"name": "right_knee", "score": 0.8626369833946228, "x": -0.12780191457550147, "y": 0.31268506346365504}, {"name": "left_ankle", "score": 0.7018249034881592, "x": 0.12877834147684836, "y": 0.5893488087523213}, {"name": "right_ankle", "score": 0.576016366481781, "x": -0.1588241824520693, "y": 0.5754106268733179}], [{"name": "nose", "score": 0.4369267523288727, "x": 0.03599340682727606, "y": -0.49926641720677634}, {"name": "left_eye", "score": 0.4867354929447174, "x": 0.038208800398936905, "y": -0.5279227137266124}, {"name": "right_eye", "score": 0.4333207607269287, "x": 0.03320114728764216, "y": -0.5282431833495924}, {"name": "left_ear", "score": 0.6329761743545532, "x": 0.02089350441294508, "y": -0.5097590732986275}, {"name": "right_ear", "score": 0.6974440813064575, "x": 0.023253393382361064, "y": -0.5129941883086967}, {"name": "left_shoulder", "score": 0.5554473996162415, "x": -0.03245596563926969, "y": -0.3998852016244731}, {"name": "right_shoulder", "score": 0.6268246173858643, "x": 0.043931006377844785, "y": -0.4000324962920364}, {"name": "left_elbow", "score": 0.5937574505805969, "x": -0.18143588112732045, "y": -0.5498131490295183}, {"name": "right_elbow", "score": 0.5256858468055725, "x": 0.26106927903752175, "y": -0.540366108947846}, {"name": "left_wrist", "score": 0.29894235730171204, "x": -0.17383572359073307, "y": -0.65964256062473}, {"name": "right_wrist", "score": 0.29532718658447266, "x": 0.2453330485592744, "y": -0.6989924090041496}, {"name": "left_hip", "score": 0.7185540199279785, "x": 0.01686529810019062, "y": -0.000639853450835728}, {"name": "right_hip", "score": 0.7664728164672852, "x": -0.016865298100191158, "y": 0.000639853450835728}, {"name": "left_knee", "score": 0.6995262503623962, "x": 0.1629065220146494, "y": 0.29750366859821203}, {"name": "right_knee", "score": 0.562695324420929, "x": -0.17895920728984568, "y": 0.2971927636848721}, {"name": "left_ankle", "score": 0.7280093431472778, "x": 0.26519504756077356, "y": 0.5492335848522206}, {"name": "right_ankle", "score": 0.6881643533706665, "x": -0.313392007292259, "y": 0.5532133847039247}], [{"name": "nose", "score": 0.643402099609375, "x": 0.021112577489220945, "y": -0.4940950601453876}, {"name": "left_eye", "score": 0.6233773827552795, "x": 0.0451867825145766, "y": -0.5182239805797976}, {"name": "right_eye", "score": 0.7883129119873047, "x": 0.0013297050075742386, "y": -0.5199106413713044}, {"name": "left_ear", "score": 0.691548228263855, "x": 0.07309095696867228, "y": -0.49573351596648924}, {"name": "right_ear", "score": 0.7394693493843079, "x": -0.020686943608488738, "y": -0.49830664276411496}, {"name": "left_shoulder", "score": 0.7688668966293335, "x": 0.13293555684904498, "y": -0.40168591979998686}, {"name": "right_shoulder", "score": 0.7151665687561035, "x": -0.08551182117656642, "y": -0.39690721145952207}, {"name": "left_elbow", "score": 0.8495465517044067, "x": 0.3054100253380364, "y": -0.44668752704067144}, {"name": "right_elbow", "score": 0.8400406241416931, "x": -0.25013263141577896, "y": -0.46063622684255523}, {"name": "left_wrist", "score": 0.5305569767951965, "x": 0.371334708235419, "y": -0.5607211241556103}, {"name": "right_wrist", "score": 0.6753974556922913, "x": -0.325584391875095, "y": -0.6216461736999479}, {"name": "left_hip", "score": 0.813911497592926, "x": 0.059300793472718424, "y": -0.0006364089967644352}, {"name": "right_hip", "score": 0.9291571974754333, "x": -0.05930079347271793, "y": 0.0006364089967639358}, {"name": "left_knee", "score": 0.8658618330955505, "x": 0.15554119750912093, "y": 0.27337344863477925}, {"name": "right_knee", "score": 0.821075975894928, "x": -0.1779335359393414, "y": 0.2747924956909098}, {"name": "left_ankle", "score": 0.6096153259277344, "x": 0.23017967594161193, "y": 0.4886243370800836}, {"name": "right_ankle", "score": 0.5415655374526978, "x": -0.26459328511366803, "y": 0.4897965841055782}], [{"name": "nose", "score": 0.6034433245658875, "x": 0.013176761589761781, "y": -0.5425911354972336}, {"name": "left_eye", "score": 0.506835401058197, "x": 0.03798758711339663, "y": -0.5688875993365152}, {"name": "right_eye", "score": 0.48692479729652405, "x": -0.00398638374775967, "y": -0.571919401214243}, {"name": "left_ear", "score": 0.716015100479126, "x": 0.07429964884586289, "y": -0.5339948195892633}, {"name": "right_ear", "score": 0.7680659890174866, "x": -0.015989593619599448, "y": -0.5491607866783041}, {"name": "left_shoulder", "score": 0.8402913212776184, "x": 0.14217614564758593, "y": -0.40100542467383327}, {"name": "right_shoulder", "score": 0.8974357843399048, "x": -0.09223197463421993, "y": -0.3974340406469812}, {"name": "left_elbow", "score": 0.756502628326416, "x": 0.2515005931330459, "y": -0.24820023282194975}, {"name": "right_elbow", "score": 0.595444917678833, "x": -0.2061823270861793, "y": -0.25561777127228574}, {"name": "left_wrist", "score": 0.6944247484207153, "x": 0.3669910685935368, "y": -0.09185052544597323}, {"name": "right_wrist", "score": 0.7691015005111694, "x": -0.3530401593460992, "y": -0.1236268801658148}, {"name": "left_hip", "score": 0.9129208922386169, "x": 0.06616300844307028, "y": 0.0014111473740305016}, {"name": "right_hip", "score": 0.8809390664100647, "x": -0.06616300844306977, "y": -0.0014111473740310138}, {"name": "left_knee", "score": 0.7998909950256348, "x": 0.08704614099631866, "y": 0.32181615563880184}, {"name": "right_knee", "score": 0.7823486924171448, "x": -0.10662361764466483, "y": 0.32012749616796515}, {"name": "left_ankle", "score": 0.5604735016822815, "x": 0.0963576442849532, "y": 0.6418780263662311}, {"name": "right_ankle", "score": 0.6653682589530945, "x": -0.14185588507342237, "y": 0.6192699779716746}], [{"name": "nose", "score": 0.484330952167511, "x": -0.023757010870053587, "y": -0.5749326520433143}, {"name": "left_eye", "score": 0.6372011303901672, "x": 0.007665271700228119, "y": -0.6114471700831873}, {"name": "right_eye", "score": 0.5474507808685303, "x": -0.02713918674221918, "y": -0.6072057742470013}, {"name": "left_ear", "score": 0.6188987493515015, "x": 0.07190559081783154, "y": -0.576171167654903}, {"name": "right_ear", "score": 0.582506000995636, "x": -0.010855714632924007, "y": -0.579954521960502}, {"name": "left_shoulder", "score": 0.6402849555015564, "x": 0.1502377037083598, "y": -0.4024833058752743}, {"name": "right_shoulder", "score": 0.7539932727813721, "x": -0.10106583839607786, "y": -0.3960040939387187}, {"name": "left_elbow", "score": 0.5731254816055298, "x": 0.16683036906536083, "y": -0.17972417125984924}, {"name": "right_elbow", "score": 0.4941401481628418, "x": -0.14611796064959212, "y": -0.19237225042551562}, {"name": "left_wrist", "score": 0.5974411368370056, "x": 0.17978244480112235, "y": -0.0034351687444698817}, {"name": "right_wrist", "score": 0.5235040187835693, "x": -0.17409422356807341, "y": 0.00018031702965642477}, {"name": "left_hip", "score": 0.7092950344085693, "x": 0.07090514763000053, "y": -0.0013231116297849896}, {"name": "right_hip", "score": 0.7605257630348206, "x": -0.07090514763000112, "y": 0.0013231116297855864}, {"name": "left_knee", "score": 0.6604864597320557, "x": 0.04395771117314953, "y": 0.31972913486787363}, {"name": "right_knee", "score": 0.6203115582466125, "x": -0.08165508955944767, "y": 0.3196937464075042}, {"name": "left_ankle", "score": 0.7119163870811462, "x": 0.036780154169979616, "y": 0.6177258006739267}, {"name": "right_ankle", "score": 0.6368623375892639, "x": -0.09691106163887568, "y": 0.603111504852261}], [{"name": "nose", "score": 0.5267756581306458, "x": 0.015826480473606668, "y": -0.5099942456404105}, {"name": "left_eye", "score": 0.35615867376327515, "x": 0.04087844483017111, "y": -0.5346836667454852}, {"name": "right_eye", "score": 0.3259353041648865, "x": -0.003048239817335983, "y": -0.533866500308245}, {"name": "left_ear", "score": 0.46906760334968567, "x": 0.06898459570800333, "y": -0.5273528885394769}, {"name": "right_ear", "score": 0.5772138833999634, "x": -0.02338560241706892, "y": -0.5246075877953038}, {"name": "left_shoulder", "score": 0.755768358707428, "x": 0.12947915852731995, "y": -0.39416253074808333}, {"name": "right_shoulder", "score": 0.8948538899421692, "x": -0.10022452801876197, "y": -0.40530239443238275}, {"name": "left_elbow", "score": 0.7155777812004089, "x": 0.31098362762783616, "y": -0.3303778581924668}, {"name": "right_elbow", "score": 0.8435065746307373, "x": -0.3041945692726916, "y": -0.3642943325528573}, {"name": "left_wrist", "score": 0.43779411911964417, "x": 0.5041122618956124, "y": -0.31074655611527974}, {"name": "right_wrist", "score": 0.5186951160430908, "x": -0.5211183259381249, "y": -0.3405484128714445}, {"name": "left_hip", "score": 0.8826385140419006, "x": 0.06999526064681563, "y": 0.002321060129094429}, {"name": "right_hip", "score": 0.8802250623703003, "x": -0.06999526064681615, "y": -0.002321060129094429}, {"name": "left_knee", "score": 0.8361445069313049, "x": 0.10241064066743645, "y": 0.309085611418912}, {"name": "right_knee", "score": 0.8957768678665161, "x": -0.10848430121713315, "y": 0.30405250168475534}, {"name": "left_ankle", "score": 0.6182283163070679, "x": 0.10687175775792378, "y": 0.609750564571398}, {"name": "right_ankle", "score": 0.6843073964118958, "x": -0.14661675516372394, "y": 0.5935316142644979}], [{"name": "nose", "score": 0.6005085706710815, "x": 0.015036353285246022, "y": -0.5207217995974293}, {"name": "left_eye", "score": 0.5587740540504456, "x": 0.0024986026081392702, "y": -0.5448157168456921}, {"name": "right_eye", "score": 0.5560773611068726, "x": 0.023899255456063435, "y": -0.5480842989136621}, {"name": "left_ear", "score": 0.6443024277687073, "x": -0.02863362703131642, "y": -0.5242361755681539}, {"name": "right_ear", "score": 0.6572610139846802, "x": 0.03619963017045282, "y": -0.5293609896586488}, {"name": "left_shoulder", "score": 0.7577525973320007, "x": -0.08601944820491433, "y": -0.3935900771787612}, {"name": "right_shoulder", "score": 0.7060385346412659, "x": 0.0917882829665547, "y": -0.40638912289177404}, {"name": "left_elbow", "score": 0.6893354654312134, "x": -0.18351181311155002, "y": -0.5557940567752956}, {"name": "right_elbow", "score": 0.7535591125488281, "x": 0.27675351352712607, "y": -0.5345404291462781}, {"name": "left_wrist", "score": 0.19053788483142853, "x": -0.16662501859517276, "y": -0.6299042330904948}, {"name": "right_wrist", "score": 0.3490655720233917, "x": 0.31595796995683384, "y": -0.6750327322362053}, {"name": "left_hip", "score": 0.7793381214141846, "x": -0.06997866662533346, "y": -0.003495634852409824}, {"name": "right_hip", "score": 0.8223057985305786, "x": 0.06997866662533346, "y": 0.003495634852409267}, {"name": "left_knee", "score": 0.6101492643356323, "x": -0.1899185523996993, "y": 0.30384683833398907}, {"name": "right_knee", "score": 0.7285245060920715, "x": 0.16736589016098846, "y": 0.31707856136872886}, {"name": "left_ankle", "score": 0.5142260789871216, "x": -0.2811366883907946, "y": 0.5166462643380461}, {"name": "right_ankle", "score": 0.48543882369995117, "x": 0.2693136204637805, "y": 0.5869747379989079}], [{"name": "nose", "score": 0.6446893811225891, "x": 0.016016368594779114, "y": -0.4982940371505225}, {"name": "left_eye", "score": 0.6885906457901001, "x": 0.03863678361915566, "y": -0.5216423364680806}, {"name": "right_eye", "score": 0.41164687275886536, "x": -0.0028287693627614763, "y": -0.5241535178782756}, {"name": "left_ear", "score": 0.7852451205253601, "x": 0.06642269352573248, "y": -0.5056525214029576}, {"name": "right_ear", "score": 0.7541217803955078, "x": -0.030476666528042234, "y": -0.509236824855046}, {"name": "left_shoulder", "score": 0.7990070581436157, "x": 0.11790594334405165, "y": -0.402745251154286}, {"name": "right_shoulder", "score": 0.8850313425064087, "x": -0.09065482333270318, "y": -0.39679047441282517}, {"name": "left_elbow", "score": 0.8554071187973022, "x": 0.2970896362508028, "y": -0.5033741478923655}, {"name": "right_elbow", "score": 0.8197399973869324, "x": -0.2321488730775909, "y": -0.5266297136723379}, {"name": "left_wrist", "score": 0.5604057312011719, "x": 0.33790477093164634, "y": -0.643754524723798}, {"name": "right_wrist", "score": 0.5012352466583252, "x": -0.23887313214659095, "y": -0.7051943552007728}, {"name": "left_hip", "score": 0.9157667756080627, "x": 0.06494883549293115, "y": 0.0005891376944715506}, {"name": "right_hip", "score": 0.8946766257286072, "x": -0.06494883549293115, "y": -0.0005891376944710277}, {"name": "left_knee", "score": 0.8561455011367798, "x": 0.1615777076970795, "y": 0.2835325954282031}, {"name": "right_knee", "score": 0.7714318633079529, "x": -0.18375082526539446, "y": 0.292928382177533}, {"name": "left_ankle", "score": 0.735298216342926, "x": 0.23143802990799167, "y": 0.4947993737789534}, {"name": "right_ankle", "score": 0.7012723684310913, "x": -0.28059957369630784, "y": 0.5049096688612316}], [{"name": "nose", "score": 0.6755749583244324, "x": 0.0013559297174036797, "y": -0.4876400570617492}, {"name": "left_eye", "score": 0.6302159428596497, "x": 0.025111419429182224, "y": -0.5169113982491323}, {"name": "right_eye", "score": 0.5668765306472778, "x": -0.016253260413516837, "y": -0.5152382662932178}, {"name": "left_ear", "score": 0.7937620878219604, "x": 0.06823706454125986, "y": -0.5119524756287938}, {"name": "right_ear", "score": 0.6511825919151306, "x": -0.017008865595845673, "y": -0.5120543163269099}, {"name": "left_shoulder", "score": 0.7851549386978149, "x": 0.14191169361482, "y": -0.4070801582259701}, {"name": "right_shoulder", "score": 0.8640161156654358, "x": -0.08824517673988566, "y": -0.39111775267489907}, {"name": "left_elbow", "score": 0.7424193620681763, "x": 0.25552881826594515, "y": -0.28291508419977607}, {"name": "right_elbow", "score": 0.7195993065834045, "x": -0.22586178770707158, "y": -0.30462267388538644}, {"name": "left_wrist", "score": 0.6432908773422241, "x": 0.38844493559902704, "y": -0.18422097359875164}, {"name": "right_wrist", "score": 0.6365901231765747, "x": -0.3859672977839657, "y": -0.26443072217154906}, {"name": "left_hip", "score": 0.7722596526145935, "x": 0.06319676928299632, "y": 0.0024750509625806366}, {"name": "right_hip", "score": 0.801993727684021, "x": -0.06319676928299632, "y": -0.0024750509625806366}, {"name": "left_knee", "score": 0.7420079112052917, "x": 0.08275710694585438, "y": 0.2986018532209972}, {"name": "right_knee", "score": 0.7604008913040161, "x": -0.1118213770361208, "y": 0.2903372931928628}, {"name": "left_ankle", "score": 0.667314350605011, "x": 0.09951889135907654, "y": 0.5911173988937067}, {"name": "right_ankle", "score": 0.7221338748931885, "x": -0.14075904699924038, "y": 0.5644219680921222}], [{"name": "nose", "score": 0.4525506794452667, "x": 0.02166179226139719, "y": -0.532710767324344}, {"name": "left_eye", "score": 0.4565877318382263, "x": 0.0384583456232453, "y": -0.5588957694725246}, {"name": "right_eye", "score": 0.40869632363319397, "x": -0.0013836409887972036, "y": -0.5578857753289815}, {"name": "left_ear", "score": 0.5587902069091797, "x": 0.07506932220185013, "y": -0.5445045782302795}, {"name": "right_ear", "score": 0.6335709095001221, "x": -0.0187339351010399, "y": -0.5537103799754722}, {"name": "left_shoulder", "score": 0.6012789607048035, "x": 0.1545108938935432, "y": -0.3984469778736232}, {"name": "right_shoulder", "score": 0.7951769828796387, "x": -0.11178228001838762, "y": -0.400411123140761}, {"name": "left_elbow", "score": 0.4170908033847809, "x": 0.17230493115651505, "y": -0.20359433506716815}, {"name": "right_elbow", "score": 0.6328694224357605, "x": -0.14817845278429537, "y": -0.18447567636875226}, {"name": "left_wrist", "score": 0.5459890365600586, "x": 0.16925763422341383, "y": 0.003239535529689217}, {"name": "right_wrist", "score": 0.5823962092399597, "x": -0.16106427380135685, "y": -0.009620188782547067}, {"name": "left_hip", "score": 0.7699583172798157, "x": 0.07209330332379967, "y": -0.001920745034691744}, {"name": "right_hip", "score": 0.786766767501831, "x": -0.07209330332379967, "y": 0.001920745034691744}, {"name": "left_knee", "score": 0.6705977320671082, "x": 0.07241579709524391, "y": 0.3397931361084317}, {"name": "right_knee", "score": 0.7308638095855713, "x": -0.050625206175010325, "y": 0.32725504210641015}, {"name": "left_ankle", "score": 0.5187289118766785, "x": 0.030154398173924884, "y": 0.6500624430127961}, {"name": "right_ankle", "score": 0.6663708686828613, "x": -0.06618710497736306, "y": 0.6390039969725688}], [{"name": "nose", "score": 0.4732205867767334, "x": 0.07209309082122205, "y": -0.5597765833796806}, {"name": "left_eye", "score": 0.5786052942276001, "x": 0.08335986480846112, "y": -0.58801147852564}, {"name": "right_eye", "score": 0.49344468116760254, "x": 0.044744632657060295, "y": -0.5896657813223006}, {"name": "left_ear", "score": 0.5365051627159119, "x": 0.0633679154028932, "y": -0.5692517409714265}, {"name": "right_ear", "score": 0.5487871170043945, "x": -0.020791061259726833, "y": -0.5730345288812638}, {"name": "left_shoulder", "score": 0.7479312419891357, "x": 0.12221266962145425, "y": -0.397426185688645}, {"name": "right_shoulder", "score": 0.7878597974777222, "x": -0.0872270784130828, "y": -0.40180845345545524}, {"name": "left_elbow", "score": 0.4529360830783844, "x": 0.1304393361436813, "y": -0.17770575260284943}, {"name": "right_elbow", "score": 0.5324558019638062, "x": -0.13296081518521474, "y": -0.16806042795062273}, {"name": "left_wrist", "score": 0.6198963522911072, "x": 0.15382532586913408, "y": -0.036377845311308915}, {"name": "right_wrist", "score": 0.2285916805267334, "x": -0.12959041899405593, "y": -0.03671592571682702}, {"name": "left_hip", "score": 0.8596463799476624, "x": 0.06130597086800937, "y": 0.0038842665446869}, {"name": "right_hip", "score": 0.8159956336021423, "x": -0.06130597086800937, "y": -0.0038842665446874856}, {"name": "left_knee", "score": 0.5988335013389587, "x": 0.030560040850735576, "y": 0.342198094900593}, {"name": "right_knee", "score": 0.6896811127662659, "x": -0.0770370403457947, "y": 0.32856477899346165}, {"name": "left_ankle", "score": 0.5010060667991638, "x": -0.004924360676490098, "y": 0.6195523006830419}, {"name": "right_ankle", "score": 0.4596007168292999, "x": -0.11703330383753949, "y": 0.6199486201452562}], [{"name": "nose", "score": 0.5419605374336243, "x": 0.04441379576867385, "y": -0.5580044895663692}, {"name": "left_eye", "score": 0.4092997908592224, "x": 0.04351509957224658, "y": -0.5785739633898319}, {"name": "right_eye", "score": 0.44987598061561584, "x": 0.02789767333721145, "y": -0.5811167535412488}, {"name": "left_ear", "score": 0.5573635697364807, "x": 0.023603392295656174, "y": -0.5592689943310791}, {"name": "right_ear", "score": 0.6248550415039062, "x": -0.002643556500069679, "y": -0.5641529497869107}, {"name": "left_shoulder", "score": 0.706087052822113, "x": 0.046979030750048695, "y": -0.40172145806374704}, {"name": "right_shoulder", "score": 0.7755343914031982, "x": -0.06413342465704247, "y": -0.39809460002066277}, {"name": "left_elbow", "score": 0.2232884168624878, "x": 0.09693337685737585, "y": -0.19494089345681498}, {"name": "right_elbow", "score": 0.42064985632896423, "x": -0.14218223385726, "y": -0.1774435297438579}, {"name": "left_wrist", "score": 0.285489946603775, "x": 0.1531895453457831, "y": -0.08598425722556974}, {"name": "right_wrist", "score": 0.5418395400047302, "x": -0.24072767909745738, "y": -0.008339357244248087}, {"name": "left_hip", "score": 0.7892858982086182, "x": 0.034485413548921165, "y": 0.0007723393384245247}, {"name": "right_hip", "score": 0.7686173319816589, "x": -0.03448541354892061, "y": -0.0007723393384250774}, {"name": "left_knee", "score": 0.7026031613349915, "x": 0.014074862795199275, "y": 0.32395672781138457}, {"name": "right_knee", "score": 0.704750657081604, "x": -0.07306849880694398, "y": 0.3238710493495631}, {"name": "left_ankle", "score": 0.6388890743255615, "x": -0.030684235501865515, "y": 0.6171039825049525}, {"name": "right_ankle", "score": 0.5241397023200989, "x": -0.1362282606191134, "y": 0.6283519082888185}]]
//}}}
var motionData = [];
var trace = 0;
(async () => {
	const response = await fetch("http://localhost:8080/api/motion");
	const result = await response.json();
	motionData = result;
	console.log(result);
})();


//app
//export default function App({motionData}) {
export default function App() {
	//state and other variables
	const [facing, setFacing] = useState(CameraType.front);

	const [ready, setReady] = useState(false);
	const [model, setModel] = useState(null);
	const [lastPose, setLastPose] = useState([]);


	//functions
	async function cameraPerms() {//{{{
		//FIXME: this still doesn't work lol, been going around it by just going out of app then back in (with recent apps button)
		const perm = await Camera.requestCameraPermissionsAsync();
		if(!perm) console.log("rip");
		if(!perm.granted) console.log("no perm");
	}//}}}

	async function prepareTF() {//{{{
		await tf.ready();
		const mcfg = {
			modelType: posedetection.movenet.modelType.SINGLEPOSE_LIGHTNING,
			enableSmoothing: true };
		//~	maybe more...
		const m = await posedetection.createDetector(
			posedetection.SupportedModels.MoveNet,
			mcfg);
		
		console.log(m.constructor.name);

		setModel(m);
		setReady(true);
	}//}}}

	function detectPose(images, updatePreview, gl) {//{{{
		console.log("onReady", images);

		async function loop() {
			requestAnimationFrame(loop);
	
			const image = images.next().value;
			if(!image) return;
			const poses = await model.estimatePoses(image, null, Date.now());
			tf.dispose([image]);

			let keypoints = poses[0].keypoints;
			setLastPose(keypoints);
			//console.log(keypoints);
		}

		loop();
	}//}}}

	function drawSingle(x, y, color, key) {//{{{
		return (<Circle key={key} cx={x} cy={y} r="7" strokeWidth="3" fill="#fff" stroke={color}></Circle>);
	}//}}}
	function draw(pose) {//{{{
		if(pose.length == 0) return false;

		//un-norm'ed
		const keypoints = pose
			.filter((p) => (p.score >= CONFIDENCE))
			.map((p) => {
				let x = (1 - (p.x / TENSOR_WIDTH)) * SCREEN_WIDTH / (RATIO * 1.5),
					y = p.y / TENSOR_HEIGHT * SCREEN_HEIGHT / (RATIO * 1.5);
				return drawSingle(x, y, "#f00", p.name);
			});

		//norm'ed
		const normed = embed(pose);
		/*const ided = normed
			? normed
				.filter((p) => (p.score >= CONFIDENCE))
				.map((p) => {
					let x = -p.x * 200 + 0.5 * SCREEN_WIDTH,
						y = p.y * 200 + 0.5 * SCREEN_HEIGHT;
					return drawSingle(x, y, "#00f", p.name);
				})
			: false;*/

		//playback part
		let selfHip = {
				x: (1 - (pose[11].x / TENSOR_WIDTH)) * SCREEN_WIDTH / (RATIO * 1.5),
				y: pose[11].y / TENSOR_HEIGHT * SCREEN_HEIGHT / (RATIO * 1.5)
			},
			selfShoulder = {
				x: (1 - (pose[6].x / TENSOR_WIDTH)) * SCREEN_WIDTH / (RATIO * 1.5),
				y: pose[6].y / TENSOR_HEIGHT * SCREEN_HEIGHT / (RATIO * 1.5)
			},
			otherHip = motionData[trace][11],
			otherShoulder = motionData[trace][6];
		let selfCross = [selfShoulder.x - selfHip.x, selfShoulder.y - selfHip.y],
			otherCross = [otherShoulder.x - otherHip.x, otherShoulder.y - otherHip.y];
		let selfDist = Math.hypot(...selfCross),
			otherDist = Math.hypot(...otherCross);
		let scale = selfDist / otherDist,
			rotation = 0,	//(Math.atan2(selfCross[1], selfCross[0]) - Math.atan2(otherCross[1], otherCross[0])),
			translation = [selfHip.x - otherHip.x, selfHip.y - otherHip.y];
		const play = motionData[trace]
			.filter((p) => (p.score >= CONFIDENCE))
			.map((p) => {
				let x = scale * (p.x * Math.cos(rotation) - p.y * Math.sin(rotation)) + translation[0],
					y = scale * (p.y * Math.cos(rotation) + p.x * Math.sin(rotation)) + translation[1];
				return drawSingle(x, y, "#0f0", p.name);
			});
		trace = (trace + 1) % motionData.length;

		//return draw element
		return (<Svg style={styles.svg}>{play}{keypoints}</Svg>);
	}//}}}

	function toggleFacing() {//{{{
		setFacing(facing == CameraType.front ? CameraType.back : CameraType.front);
		console.log("flip");
	}//}}}


	//init
	//{{{
	useEffect(() => {
		cameraPerms();
		prepareTF();
	}, []);
	//}}}


	//view
	//{{{
	if(ready) {
		return (<View style={styles.container}>
			<Pressable style={styles.flipper} onPress={toggleFacing}>
				<TensorCamera style={styles.camera}
					type={facing}
					onReady={detectPose}
					resizeWidth={TENSOR_WIDTH}
					resizeHeight={TENSOR_HEIGHT}
					resizeDepth={3}>
				</TensorCamera>
				{draw(lastPose)}
			</Pressable>
		</View>);
	}
	else {
		return (<View style={styles.loading}>
			<Text> Now Loading... </Text>
		</View>);
	}
	//}}}
};

const styles = StyleSheet.create({//{{{
	container: {
		flex: 1
	},
	top: {
		flex: 8
	},
	bottom: {
		flex: 2,
		flexDirection: "row"
	},
	camera: {
		flex: 1,
		aspectRatio: RATIO
	},
	svg: {
		width: "100%",
		height: "100%",
		position: "absolute",
		zIndex: 100
	},
	flipper: {
		flex: 1,
		justifyContent: "center",
		alignItems: "center"
	},
	record: {
		flex: 1,
		justifyContent: "center",
		alignItems: "center"
	},
	loading: {
		flex: 1,
		justifyContent: "center",
		alignItems: "center"
	}
});//}}}

